name: Build with Smart Annotations

on:
  pull_request:
    branches: [main, integration/*]

jobs:
  build-and-annotate:
    name: Build & Annotate Errors
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build with error parsing
        id: build
        continue-on-error: true
        run: |
          # Capture build output
          pnpm build 2>&1 | tee build-log.txt

          # Parse TypeScript errors and create annotations
          if grep -q "Type error:" build-log.txt; then
            echo "::error::TypeScript compilation failed. See annotations for details."

            # Parse errors and create annotations
            while IFS= read -r line; do
              # Extract file, line, and error message
              if [[ $line =~ \./([^:]+):([0-9]+):([0-9]+) ]]; then
                FILE="${BASH_REMATCH[1]}"
                LINE="${BASH_REMATCH[2]}"
                COL="${BASH_REMATCH[3]}"

                # Get error message (next line usually)
                ERROR_MSG=$(echo "$line" | sed 's/.*Type error: //')

                # Create annotation
                echo "::error file=$FILE,line=$LINE,col=$COL,title=TypeScript Error::$ERROR_MSG"

                # Add suggestion if common error
                if [[ $ERROR_MSG =~ "Module.*has no exported member" ]]; then
                  echo "::notice file=$FILE,line=$LINE::ðŸ’¡ Suggestion: Run 'pnpm install' to ensure dependencies are up to date, or check if you're importing from the correct package."
                fi

                if [[ $ERROR_MSG =~ "Cannot find module" ]]; then
                  echo "::notice file=$FILE,line=$LINE::ðŸ’¡ Suggestion: Make sure the file exists and the path is correct. Check for typos in the import statement."
                fi
              fi
            done < build-log.txt
          fi

          exit ${PIPESTATUS[0]}

      - name: TypeScript error summary
        if: failure()
        run: |
          echo "### ðŸ” Quick Fixes for Common TypeScript Errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Module has no exported member:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'pnpm install  # Update dependencies' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cannot find module:**" >> $GITHUB_STEP_SUMMARY
          echo "- Check file path spelling" >> $GITHUB_STEP_SUMMARY
          echo "- Verify file exists" >> $GITHUB_STEP_SUMMARY
          echo "- Check import syntax" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run \`pnpm build\` locally to see full error details." >> $GITHUB_STEP_SUMMARY
